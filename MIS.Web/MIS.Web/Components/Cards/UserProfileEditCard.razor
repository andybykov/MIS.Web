@inject UserManager userManager
@inject NavigationManager Navigation

@rendermode InteractiveServer


@if (userOm == null)
{
    return;
}

<span class="badge bg-secondary me-2">ID: @userOm?.Id</span>
    @if (userOm?.IsRemoved == true)
    {
        <span class="badge bg-danger">Пользователь удален</span>
    }
    <div class="card-body">
        <!-- Основная информация в две колонки -->
        <div class="row mb-3">
            <div class="col-md-6">
                <!-- Полное имя -->
                <div class="mb-2">
                    <strong class="text-muted d-block">Имя и Фамилия:</strong>
                    @if (isEditing)
                    {
                        <div class="row g-2">
                            <div class="col">
                                <input @bind="userOm.FullName" class="form-control form-control-sm" placeholder="Имя и Фамилия" />
                            </div>                        
                        </div>
                    }
                    else
                    {
                        <span class="fs-5 text-dark">@userOm?.FullName</span>
                    }
                </div>

                <!-- Роль -->
                <div class="mb-2">
                    <strong class="text-muted d-block">Роль:</strong>
                    @if (isEditing)
                    {
                        <select @bind="userOm.Role" class="form-select form-select-sm">
                            @foreach (UserRole role in Enum.GetValues(typeof(UserRole)))
                            {
                                <option value="@role">@role</option>
                            }
                        </select>
                    }
                    else
                    {
                        @if (userOm?.Role == UserRole.Client)
                        {
                            <span class="badge bg-success">@userOm?.Role</span>
                        }
                        else if (userOm?.Role == UserRole.Admin)
                        {
                            <span class="badge bg-warning text-dark">@userOm?.Role</span>
                        }
                        else
                        {
                            <span class="badge bg-primary">@userOm?.Role</span>
                        }
                    }
                </div>

                <!-- Пол -->
                <div class="mb-2">
                    <strong class="text-muted d-block">Пол:</strong>
                    @if (isEditing)
                    {
                        <select @bind="userOm.Gender" class="form-select form-select-sm">
                            @foreach (Gender gender in Enum.GetValues(typeof(Gender)))
                            {
                                <option value="@gender">@gender</option>
                            }
                        </select>
                    }
                    else
                    {
                        <span>@userOm?.Gender</span>
                    }
                </div>
            </div>

            <div class="col-md-6">
                <!-- Дата регистрации (не редактируется) -->
                <div class="mb-2">
                    <strong class="text-muted d-block">Дата регистрации:</strong>
                    <span>@userOm?.RegistrationDate.ToString("dd.MM.yyyy HH:mm")</span>
                </div>

                <!-- Дата рождения -->
                <div class="mb-2">
                    <strong class="text-muted d-block">Дата рождения:</strong>
                    @if (isEditing)
                    {
                        <input type="date" @bind="userOm.DateOfBirth" @bind:format="yyyy-MM-dd"
                               class="form-control form-control-sm" />
                    }
                    else
                    {
                        <span>
                            <i class="fas fa-birthday-cake me-2 text-secondary"></i>
                            @userOm?.DateOfBirth.ToString("dd.MM.yyyy")
                            <small class="text-muted ms-2">
                                (Возраст: @(userOm != null ? (DateTime.Now.Year - userOm.DateOfBirth.Year) : 0))
                            </small>
                        </span>
                    }
                </div>
            </div>
        </div>

        <!-- Контактная информация -->
        <div class="row border-top pt-3">
            <div class="col-md-6">
                <div class="mb-2">
                    <strong class="text-muted d-block">Email:</strong>
                    @if (isEditing)
                    {
                        <input @bind="userOm.Email" class="form-control form-control-sm" placeholder="Email" />
                    }
                    else
                    {
                        <span>
                            <i class="fas fa-envelope me-2 text-secondary"></i>
                            @userOm?.Email
                        </span>
                    }
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-2">
                    <strong class="text-muted d-block">Телефон:</strong>
                    @if (isEditing)
                    {
                        <input @bind="userOm.PhoneNumber" class="form-control form-control-sm" placeholder="Телефон" />
                    }
                    else
                    {
                        <span>
                            <i class="fas fa-phone me-2 text-secondary"></i>
                            @userOm?.PhoneNumber
                        </span>
                    }
                </div>
            </div>
        </div>

        <!-- Защищенная информация -->
        <div class="row border-top pt-3">
            <div class="col-12">
                <div class="alert alert-warning mb-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong class="text-muted">Пароль:</strong>
                            @if (isEditing)
                            {
                                <input type="text" @bind="userOm.Password"
                                       class="form-control form-control-sm d-inline-block w-auto ms-2"/>
                            }
                            else
                            {
                                <span class="ms-2">
                                    <i class="fas fa-lock me-1"></i>
                                    @if (showPassword)
                                    {
                                        @userOm?.Password
                                    }
                                    else
                                    {
                                        <span>••••••••</span>
                                    }
                                </span>
                            }
                        </div>    
                        @if (!isEditing)
                        {
                        <button type="button"
                            class="btn btn-outline-secondary btn-sm"
                            @onclick="TogglePasswordVisibility">
                                @if (showPassword)
                                    {
                                        @:Скрыть
                                    }
                                else
                                    {
                                        @:Показать
                                    }
                        </button>
                        }
                </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card-footer bg-transparent">
        <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted">
                Обновлен: @DateTime.Now.ToString("dd.MM.yyyy HH:mm")
            </small>

            <div>
                @if (isEditing)
                {
                    <button type="button" class="btn btn-success btn-sm me-2" @onclick="SaveUser">
                        <i class="fas fa-save me-1"></i>Сохранить
                    </button>
                    <button type="button" class="btn btn-secondary btn-sm" @onclick="CancelEdit">
                        <i class="fas fa-times me-1"></i>Отмена
                    </button>
                }
                else
                {
                    @* <button type="button" class="btn btn-primary btn-sm me-2" @onclick="OnClickCallback">
                        Open Details
                    </button> *@
                    <button type="button" class="btn btn-primary btn-sm me-2" @onclick="StartEditing">
                        <i class="fas fa-edit me-1"></i>Редактировать
                    </button>
                    <button type="button" class="btn btn-danger btn-sm me-2" @onclick="() => OnRemoveUser(UserId)">
                        Remove
                    </button>
                    <button type="button" class="btn btn-outline-danger btn-sm me-2" @onclick="() => OnDeleteUser(UserId)">
                        Delete!
                    </button>
                }
            </div>
        </div>
    </div>

@code {
    private UserOutputModel userOm;

    private bool showPassword = false;

    private bool isEditing = false;

    [Parameter]
    public int UserId { get; set; }

    [Parameter]
    public EventCallback<MouseEventArgs> OnClickCallback { get; set; }

    [Parameter]
    public EventCallback<int> OnUserRemoved { get; set; }

    [Parameter]
    public EventCallback<int> OnUserDeleted { get; set; }

    [Parameter]
    public EventCallback<int> OnUserUpdated { get; set; }

    protected override void OnInitialized()
    {
        userOm = userManager.GetById(UserId);
        base.OnInitialized();
    }

    private void TogglePasswordVisibility()
    {
        showPassword = !showPassword;
    }

    private void StartEditing()
    {
        if (userOm != null)
        {
            
            userOm = new UserOutputModel
            {
                Id = userOm.Id,
                FullName = userOm.FullName,                
                Email = userOm.Email ?? "",
                PhoneNumber = userOm.PhoneNumber ?? "",
                Role = userOm.Role,
                Gender = userOm.Gender,
                DateOfBirth = userOm.DateOfBirth,
                Password = userOm.Password, 
            };
            isEditing = true;
        }
    }

    private async Task SaveUser()
    {
        if (userOm != null)
        {
            // Обновляем данные
            var updated = userManager.Update(UserId, userOm);

            if (updated)
            {                
               // userOm = userManager.GetById(UserId);
                isEditing = false;

                // Уведомляем родительский компонент об обновлении
                await OnUserUpdated.InvokeAsync(UserId);
                StateHasChanged();
            }
        }
    }

    private void CancelEdit()
    {
        isEditing = false;
    }

    private async Task OnRemoveUser(int userId)
    {
        var removed = userManager.Remove(userId);
        if (removed)
        {
            await OnUserRemoved.InvokeAsync(userId);
        }
    }

    private async Task OnDeleteUser(int userId)
    {
        var deleted = userManager.Delete(userId);
        if (deleted)
        {
            await OnUserDeleted.InvokeAsync(userId);
        }
    }
}